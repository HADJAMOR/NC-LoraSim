<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NC-LoraSim</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Chart.js and datalabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

 
      <style>
        /* Style pour la barre de navigation */
        .w-full {
            width: 100%;
        }
        
        .bg-white {
            background-color: white;
        }
        
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .rounded-2xl {
            border-radius: 1rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .max-w-7xl {
            max-width: 80rem;
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .text-blue-600 {
            color: #2563eb;
        }
        
        .space-x-6 > * + * {
            margin-left: 1.5rem;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .hover\:text-blue-600:hover {
            color: #2563eb;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .relative {
            position: relative;
        }
        
        .group:hover .group-hover\:block {
            display: block;
        }
        
        .focus\:outline-none:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }
        
        .ml-1 {
            margin-left: 0.25rem;
        }
        
        .h-4 {
            height: 1rem;
        }
        
        .w-4 {
            width: 1rem;
        }
        
        .absolute {
            position: absolute;
        }
        
        .right-0 {
            right: 0;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .w-40 {
            width: 10rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .ring-1 {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
        
        .ring-gray-200 {
            --tw-ring-color: rgba(229, 231, 235, 1);
        }
        
        .hidden {
            display: none;
        }
        
        .block {
            display: block;
        }
        
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .hover\:bg-red-50:hover {
            background-color: #fef2f2;
        }
        
        .hover\:text-red-600:hover {
            color: #dc2626;
        }
        
        .transition-colors {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Styles existants */
        .config-active {
            border-left: 3px solid #007bff;
            padding-left: 10px;
            transition: all 0.3s ease;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --border-radius: 6px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        h1, h2 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 2.2rem;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 30px;
        }

        h2 {
            font-size: 1.6rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        }

        .form-control, .form-select {
            border-radius: var(--border-radius);
            padding: 10px 15px;
            border: 1px solid #ddd;
            transition: border-color 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            border: none;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-submit:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            border: none;
        }

        .table td, .table th {
            padding: 12px 15px;
            vertical-align: middle;
        }

        .table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table tr:hover {
            background-color: #f1f7fd;
        }

        .table-container {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            max-height: 400px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-track {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .navigation-arrows {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .arrow-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--box-shadow);
        }

        .arrow-btn:hover {
            background-color: #2980b9;
            transform: scale(1.1);
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        .chart-container canvas {
            width: 100% !important;
            height: auto !important;
        }

        .form-check-label {
            margin-left: 5px;
            font-weight: 400;
        }

        .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 0.3em;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .badge {
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 4px;
        }

        .badge-primary {
            background-color: var(--primary-color);
        }

        .badge-success {
            background-color: var(--success-color);
        }

        .badge-warning {
            background-color: var(--warning-color);
        }

        .badge-danger {
            background-color: var(--danger-color);
        }

        #legend {
            margin: 15px 0;
            text-align: center;
        }

        #legend span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin: 0 8px;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
        }

        /* Dropdown simple */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  background: none;
  border: none;
  color: #374151;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  font-family: 'Roboto', sans-serif;
}

.dropdown-toggle:hover {
  color: #2563eb;
}

.dropdown-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 120%;
  background-color: white;
  width: 160px;
  border-radius: 0.5rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.dropdown:hover .dropdown-menu {
  display: block;
}

.dropdown-menu a {
  display: block;
  padding: 10px 16px;
  font-size: 0.875rem;
  color: #374151;
  text-decoration: none;
  transition: all 0.2s;
}

.dropdown-menu a:hover {
  background-color: #fef2f2;
  color: #dc2626;
}

    </style>
</head>
<body>
 <!-- Navigation bar with simplified user menu and active page indicator (Manual Simulation) -->
<nav class="w-full bg-white shadow-md rounded-2xl mb-8 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <!-- Logo -->
      <div class="text-xl font-bold text-blue-600">NC-LoraSim</div>
  
      <!-- Main menu -->
      <div class="flex items-center space-x-6">
        <a href="/index.html" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
        <a href="/connexion.html" class="text-gray-700 hover:text-blue-600 font-medium">Login</a>
        <a href="/simulation-manager.html" class="text-gray-700 hover:text-blue-600 font-medium">Automatic Mode</a>
        <a href="/NS3-LoRaWan.html" class="text-blue-600 font-semibold underline">Manual Mode</a>
      </div>
  
      <!-- User menu -->
      <div class="dropdown">
        <button id="accountBtn" class="btn btn-light dropdown-toggle" type="button">
          My Account
        </button>
        <div id="accountMenu" class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item text-danger" href="/connexion_Ang.html">Logout</a>
        </div>
      </div>
    </div>
  </nav>
  
  

    <div class="container">
        <h1>NC-LoraSim: Manual Mode</h1>

        <div class="card">
            <div class="card-header">
                Simulation Parameters
            </div>
            <div class="card-body">
                <form id="form">
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="appPeriod">Sending frequency (minutes)</label>
                            <input type="number" class="form-control" id="appPeriod" name="appPeriod" value="12">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="payload">Payload (bytes)</label>
                            <input type="number" class="form-control" id="payload" name="payload" value="20">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="nGateways">Number of gateways</label>
                            <input type="number" class="form-control" id="nGateways" name="nGateways" value="3">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="nDevices">Number of nodes</label>
                            <input type="number" class="form-control" id="nDevices" name="nDevices" value="30">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="Rayon">Simulation radius (meters)</label>
                            <input type="number" class="form-control" id="radius" name="radius" value="7500">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="Duree">Simulation duration (minutes)</label>
                            <input type="number" class="form-control" id="simulationTime" name="simulationTime" value="60">
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="batiments" name="batiments">
                        <label class="form-check-label" for="batiments">
                            Include buildings
                        </label>
                    </div>

                    <!-- HTML Form -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="manualCoordinates" onclick="toggleConfig2('Coordinates')">
                        <label class="form-check-label" for="manualCoordinates">
                            Manual gateway coordinates configuration
                        </label>
                    </div>
                    
                    <div class="form-group" id="Coordinates-config" style="display:none;">
                        <label for="gatewayPositions">Coordinates (format: X,Y,Z;X,Y,Z...)</label>
                        <input type="text" class="form-control" id="gatewayPositions" placeholder="Ex: 0,0,0;4000,4000,0">
                    </div>

<div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="manualSF" onclick="toggleConfig('sf')">
    <label class="form-check-label" for="manualSF">
        Manual spreading factors configuration
    </label>
</div>

<div class="form-group" id="sf-config" style="display:none;">
    <label for="sfValues">Spreading factors (format: SF0,SF1,SF2...)</label>
    <input type="text" class="form-control" id="sfValues" placeholder="Ex: 7,8,9,10,11,12">
</div>

<div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="manualPT" onclick="toggleConfig('pt')">
    <label class="form-check-label" for="manualPT">
        Manual transmission powers configuration
    </label>
</div>

<div class="form-group" id="pt-config" style="display:none;">
    <label for="ptValues">Power values (format: PT0,PT1,PT2...)</label>
    <input type="text" class="form-control" id="ptValues" placeholder="Ex: 14,12,10,8,6,4">
</div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-submit">Run simulation</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                Simulation Summary
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="summaryTable" class="table">
                        <thead>
                            <tr>
                                <th>Packets sent</th>
                                <th>Packets received</th>
                                <th>PDR (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="totalSent">0</td>
                                <td id="totalReceived">0</td>
                                <td id="pdr">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Packets received per gateway
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="gatewayTable" class="table">
                                <thead>
                                    <tr>
                                        <th>Gateway ID</th>
                                        <th>Packets received</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows filled dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                Node Details
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table id="resultTable" class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>X</th>
                                <th>Y</th>
                                <th>SF</th>
                                <th>Sent</th>
                                <th>Received</th>
                                <th>PDR</th>
                                <th>ToA (ms)</th>
                                <th>Rate (kbps)</th>
                                <th>Energy (J)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="navigation-arrows">
            <button class="arrow-btn" id="prevBtn" onclick="changeGraph('prev')">←</button>
            <button class="arrow-btn" id="nextBtn" onclick="changeGraph('next')">→</button>
        </div>

        

        <div id="chartWithColor" class="chart-container" style="display: none;">
            <h2>Chart: By Loss</h2>
            <canvas id="nodeChart"></canvas>
        </div>

        <div id="chartWithoutColor" class="chart-container" style="display: none;">
            <h2>Chart: Positions</h2>
            <canvas id="uniformNodeChart"></canvas>
        </div>

        <div id="sfChart" class="chart-container" style="display: none;">
            <h2>Chart: By SF</h2>
            <canvas id="sfNodeChart"></canvas>
        </div>
    </div>

    <!-- JS Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
          document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll("nav a");
    const currentPage = window.location.pathname;

    links.forEach(link => {
      if (link.getAttribute("href") === currentPage) {
        link.classList.add("text-blue-600", "font-semibold", "underline");
      }
    });
  });
        let chart, uniformChart, sfChart;
        let currentGraph = 'uniform';
        document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("accountBtn");
    const menu = document.getElementById("accountMenu");

    btn.addEventListener("click", function (e) {
      e.stopPropagation(); // Empêche la fermeture immédiate
      menu.classList.toggle("show");
    });

    document.addEventListener("click", function () {
      menu.classList.remove("show");
    });
  });
        function toggleConfig2(type, options = {}) {
    const { forceCheck = null, debug = false } = options;
    const typeUpper = type.charAt(0).toUpperCase() + type.slice(1);
    const configDiv = document.getElementById(`${type}-config`);
    const checkbox = document.getElementById(`manual${typeUpper}`) || 
                   document.getElementById(`manual${type}`);

    if (debug) console.log(`[Debug] toggleConfig called for ${type}`);

    // Check elements
    if (!configDiv || !checkbox) {
        const errorMsg = `Missing elements: ${!configDiv ? `${type}-config` : ''} ${!checkbox ? `manual${typeUpper}` : ''}`.trim();
        console.error(errorMsg);
        return false;
    }

    // Determine state
    const isChecked = forceCheck !== null ? forceCheck : checkbox.checked;
    
    // Apply changes
    configDiv.style.display = isChecked ? 'block' : 'none';
    configDiv.classList.toggle('config-active', isChecked);

    // Return applied state for chaining
    return isChecked;
}
        function toggleConfig(type) {
    try {
        const configDiv = document.getElementById(`${type}-config`);
        const checkbox = document.getElementById(`manual${type.toUpperCase()}`);
        
        if (!configDiv || !checkbox) {
            throw new Error(`Elements not found for ${type}`);
        }
        
        configDiv.style.display = checkbox.checked ? 'block' : 'none';
        
        // Optional: Add class for styling
        if (checkbox.checked) {
            configDiv.classList.add('config-active');
        } else {
            configDiv.classList.remove('config-active');
        }
    } catch (error) {
        console.error("Configuration error:", error);
    }
}

        document.getElementById("form").addEventListener("submit", function(event) {
            event.preventDefault();

            const appPeriod = document.getElementById("appPeriod").value;
            const payload = document.getElementById("payload").value;
            const nGateways = document.getElementById("nGateways").value;
            const nDevices = document.getElementById("nDevices").value;
            const batiments = document.getElementById('batiments').checked ? 'true' : 'false';
            const radius = document.getElementById('radius').value;
            const simulationTime = document.getElementById('simulationTime').value;

            
            
            const checkboxCoordinates = document.getElementById("manualCoordinates");
            let gatewayPositions = "";
            if (checkboxCoordinates.checked) {
                gatewayPositions = document.getElementById("gatewayPositions").value;
            }
            
            const checkboxSF = document.getElementById("manualSF");
            let sftable = "";
            if (checkboxSF.checked) {
                sftable = document.getElementById("sftable").value;
            }

            const url = `/advanced-execute?appPeriod=${appPeriod}&payload=${payload}&nGateways=${nGateways}&nDevices=${nDevices}&Batiments=${batiments}&gatewayPositions=${encodeURIComponent(gatewayPositions)}&sftable=${encodeURIComponent(sftable)}&radius=${radius}&simulationTime=${simulationTime}&manualCoordinates=${manualCoordinates}&manualPT=${manualPT}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    const tableBody = document.querySelector('#resultTable tbody');
                    tableBody.innerHTML = '';
                    let totalSent = 0;
                    let totalReceived = 0;

                    const nodePositions = [];
                    const uniformNodePositions = [];
                    const sfPositions = [];

                    // Gateway processing - CORRECTED VERSION
                    const gatewayTableBody = document.querySelector('#gatewayTable tbody');
                    gatewayTableBody.innerHTML = '';
                    
                    const nGatewaysInt = parseInt(nGateways);
                    const gatewayResults = {};
                    
                    // Initialize all gateways to 0
                    for (let i = 0; i < nGatewaysInt; i++) {
                        gatewayResults[i] = 0;
                    }
                    
                    // Fill with found data
                    data.forEach(line => {
                        const match = line.match(/Gateway\s+(\d+)\s*:\s*(\d+)/);
                        if (match) {
                            const gwId = parseInt(match[1]);
                            const packets = parseInt(match[2]);
                            if (gwId >= 0 && gwId < nGatewaysInt) {
                                gatewayResults[gwId] = packets;
                            }
                        }
                    });
                    
                   // Display all requested gateways
for (let i = 0; i < nGatewaysInt; i++) {
    const row = document.createElement('tr');
    const idCell = document.createElement('td');
    const receivedCell = document.createElement('td');
    
    idCell.textContent = `Gateway ${i}`;
    receivedCell.textContent = gatewayResults[i] || 0;
    
    row.appendChild(idCell);
    row.appendChild(receivedCell);
    gatewayTableBody.appendChild(row);
}
                    // Node processing
                    data.forEach(line => {
                        const row = document.createElement('tr');
                        const columns = line.split('|').map(item => item.trim());
                        
                        if (columns[0].startsWith('Pass')) {
                            return;
                        }

                        columns.forEach(col => {
                            const cell = document.createElement('td');
                            cell.textContent = col;
                            row.appendChild(cell);
                        });

                        tableBody.appendChild(row);

                        const sent = parseInt(columns[4]);
                        const received = parseInt(columns[5]);

                        totalSent += sent;
                        totalReceived += received;

                        let color = 'blue';
                        if (received === 0) color = 'red';
                        else if (sent === received) color = 'green';

                        nodePositions.push({
                            x: parseFloat(columns[1]),
                            y: parseFloat(columns[2]),
                            backgroundColor: color,
                            label: ` ${columns[0]}`
                        });

                        uniformNodePositions.push({
                            x: parseFloat(columns[1]),
                            y: parseFloat(columns[2]),
                            backgroundColor: 'gray',
                            label: ` ${columns[0]}`
                        });

                        sfPositions.push({
                            x: parseFloat(columns[1]),
                            y: parseFloat(columns[2]),
                            radius: parseInt(columns[3]),
                            label: ` ${columns[0]}`
                        });
                    });

                    const pdr = totalSent > 0 ? (totalReceived / totalSent * 100).toFixed(2) : 0;
                    document.getElementById("totalSent").textContent = totalSent;
                    document.getElementById("totalReceived").textContent = totalReceived;
                    document.getElementById("pdr").textContent = pdr;

                    // Gateway positions for charts
                    let gatewayChartPositions = [];
                    if (nGatewaysInt == 1) {
                        gatewayChartPositions = [
                            { x: 0, y: 0, backgroundColor: 'black', label: 'Gateway 0' }
                        ];
                    } else if (nGatewaysInt == 2) {
                        gatewayChartPositions = [
                            { x: 0, y: 0, backgroundColor: 'black', label: 'Gateway 0' },
                            { x: 4000, y: 4000, backgroundColor: 'black', label: 'Gateway 1' }
                        ];
                    } else if (nGatewaysInt == 3) {
                        gatewayChartPositions = [
                            { x: 0, y: 0, backgroundColor: 'black', label: 'Gateway 0' },
                            { x: 4000, y: 4000, backgroundColor: 'black', label: 'Gateway 1' },
                            { x: -4000, y: -4000, backgroundColor: 'black', label: 'Gateway 2' }
                        ];
                    } else if (nGatewaysInt == 4) {
                        gatewayChartPositions = [
                            { x: 0, y: 0, backgroundColor: 'black', label: 'Gateway 0' },
                            { x: 4000, y: 4000, backgroundColor: 'black', label: 'Gateway 1' },
                            { x: -4000, y: -4000, backgroundColor: 'black', label: 'Gateway 2' },
                            { x: -4000, y: 4000, backgroundColor: 'black', label: 'Gateway 3' }
                        ];
                    } else if (nGatewaysInt == 5) {
                        gatewayChartPositions = [
                            { x: 0, y: 0, backgroundColor: 'black', label: 'Gateway 0' },
                            { x: 4000, y: 4000, backgroundColor: 'black', label: 'Gateway 1' },
                            { x: -4000, y: -4000, backgroundColor: 'black', label: 'Gateway 2' },
                            { x: -4000, y: 4000, backgroundColor: 'black', label: 'Gateway 3' },
                            { x: 4000, y: -4000, backgroundColor: 'black', label: 'Gateway 4' }
                        ];
                    }

                    // Chart with loss coloring
                    const ctx = document.getElementById('nodeChart').getContext('2d');
                    if (chart) chart.destroy();

                    chart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [
                                {
                                    label: 'No loss',
                                    data: nodePositions.filter(n => n.backgroundColor === 'green'),
                                    backgroundColor: 'green',
                                    borderColor: 'green',
                                    pointRadius: 5
                                },
                                {
                                    label: 'Partial loss',
                                    data: nodePositions.filter(n => n.backgroundColor === 'blue'),
                                    backgroundColor: 'blue',
                                    borderColor: 'blue',
                                    pointRadius: 5
                                },
                                {
                                    label: 'Total loss',
                                    data: nodePositions.filter(n => n.backgroundColor === 'red'),
                                    backgroundColor: 'red',
                                    borderColor: 'red',
                                    pointRadius: 5
                                },
                                {
                                    label: 'Gateway',
                                    data: gatewayChartPositions,
                                    backgroundColor: 'black',
                                    borderColor: 'black',
                                    pointStyle: 'rect',
                                    pointRadius: 10
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        boxWidth: 20,
                                        boxHeight: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                datalabels: {
                                    align: 'top',
                                    anchor: 'end',
                                    color: '#000',
                                    font: { weight: 'bold', size: 12 },
                                    formatter: (val) => val.label
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    title: { 
                                        display: true, 
                                        text: 'X Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                y: {
                                    title: { 
                                        display: true, 
                                        text: 'Y Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });

                    // Uniform chart
                    const uniformCtx = document.getElementById('uniformNodeChart').getContext('2d');
                    if (uniformChart) uniformChart.destroy();

                    uniformChart = new Chart(uniformCtx, {
                        type: 'scatter',
                        data: {
                            datasets: [
                                {
                                    label: 'Node',
                                    data: uniformNodePositions,
                                    backgroundColor: uniformNodePositions.map(n => n.backgroundColor),
                                    borderColor: uniformNodePositions.map(n => n.backgroundColor),
                                    pointRadius: 5
                                },
                                {
                                    label: 'Gateway',
                                    data: gatewayChartPositions,
                                    backgroundColor: 'black',
                                    borderColor: 'black',
                                    pointStyle: 'rect',
                                    pointRadius: 10
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        boxWidth: 20,
                                        boxHeight: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                datalabels: {
                                    align: 'top',
                                    anchor: 'end',
                                    color: '#000',
                                    font: { weight: 'bold', size: 12 },
                                    formatter: (val) => val.label
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    title: { 
                                        display: true, 
                                        text: 'X Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                y: {
                                    title: { 
                                        display: true, 
                                        text: 'Y Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });

                    // SF Chart - CORRECTED VERSION
                    const sfCtx = document.getElementById('sfNodeChart').getContext('2d');
                    if (sfChart) sfChart.destroy();

                    // Prepare data grouped by SF
                    const sfGroups = {
                        7: { color: '#AED6F1', data: [] },
                        8: { color: '#5DADE2', data: [] },
                        9: { color: '#A569BD', data: [] },
                        10: { color: '#D98880', data: [] },
                        11: { color: '#E74C3C', data: [] },
                        12: { color: '#922B21', data: [] }
                    };

                    // Group nodes by SF
                    sfPositions.forEach(node => {
                        const sf = node.radius; // SF is stored in radius
                        if (sfGroups[sf]) {
                            sfGroups[sf].data.push({
                                x: node.x,
                                y: node.y,
                                label: node.label
                            });
                        }
                    });

                    // Create datasets for Chart.js
                    const sfDatasets = Object.entries(sfGroups).map(([sf, group]) => ({
                        label: `SF${sf}`,
                        data: group.data,
                        backgroundColor: group.color,
                        borderColor: group.color,
                        pointRadius: 7,
                        pointHoverRadius: 9
                    }));

                    // Add gateway dataset
                    sfDatasets.push({
                        label: 'Gateways',
                        data: gatewayChartPositions,
                        backgroundColor: 'black',
                        borderColor: 'black',
                        pointStyle: 'rect',
                        pointRadius: 10,
                        pointHoverRadius: 12
                    });

                    sfChart = new Chart(sfCtx, {
                        type: 'scatter',
                        data: {
                            datasets: sfDatasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        boxWidth: 20,
                                        boxHeight: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                datalabels: {
                                    align: 'top',
                                    anchor: 'end',
                                    color: '#000',
                                    font: { weight: 'bold', size: 12 },
                                    formatter: (val) => val.label
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    title: { 
                                        display: true, 
                                        text: 'X Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                y: {
                                    title: { 
                                        display: true, 
                                        text: 'Y Position',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });

                    // Display charts
                    document.getElementById('chartWithColor').style.display = 'none';
                    document.getElementById('chartWithoutColor').style.display = 'block';
                    document.getElementById('sfChart').style.display = 'none';
                    document.getElementById('legend').style.display = 'block';
                    currentGraph = 'uniform';
                });
        });

        function changeGraph(direction) {
            const graphs = ['uniform', 'color', 'sf'];
            let currentIndex = graphs.indexOf(currentGraph);

            if (direction === 'next') {
                currentIndex = (currentIndex + 1) % graphs.length;
            } else if (direction === 'prev') {
                currentIndex = (currentIndex - 1 + graphs.length) % graphs.length;
            }

            document.getElementById('chartWithColor').style.display = 'none';
            document.getElementById('chartWithoutColor').style.display = 'none';
            document.getElementById('sfChart').style.display = 'none';

            if (graphs[currentIndex] === 'uniform') {
                document.getElementById('chartWithoutColor').style.display = 'block';
            } else if (graphs[currentIndex] === 'color') {
                document.getElementById('chartWithColor').style.display = 'block';
            } else if (graphs[currentIndex] === 'sf') {
                document.getElementById('sfChart').style.display = 'block';
            }

            currentGraph = graphs[currentIndex];
        }
    </script>
</body>
</html>