<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NC-LoraSim - Mode automatique</title>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>

    /* Style pour la barre de navigation */
    .w-full {
            width: 100%;
        }
        
        .bg-white {
            background-color: white;
        }
        
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .rounded-2xl {
            border-radius: 1rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .max-w-7xl {
            max-width: 80rem;
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .text-blue-600 {
            color: #2563eb;
        }
        
        .space-x-6 > * + * {
            margin-left: 1.5rem;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .hover\:text-blue-600:hover {
            color: #2563eb;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .relative {
            position: relative;
        }
        
        .group:hover .group-hover\:block {
            display: block;
        }
        
        .focus\:outline-none:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }
        
        .ml-1 {
            margin-left: 0.25rem;
        }
        
        .h-4 {
            height: 1rem;
        }
        
        .w-4 {
            width: 1rem;
        }
        
        .absolute {
            position: absolute;
        }
        
        .right-0 {
            right: 0;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .w-40 {
            width: 10rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .ring-1 {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
        
        .ring-gray-200 {
            --tw-ring-color: rgba(229, 231, 235, 1);
        }
        
        .hidden {
            display: none;
        }
        
        .block {
            display: block;
        }
        
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .hover\:bg-red-50:hover {
            background-color: #fef2f2;
        }
        
        .hover\:text-red-600:hover {
            color: #dc2626;
        }
        
        .transition-colors {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --border-radius: 6px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Roboto', sans-serif;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin-top: 40px;
      margin-bottom: 40px;
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    h1 {
      color: var(--secondary-color);
      text-align: center;
      margin-bottom: 40px;
      font-weight: 700;
      position: relative;
      padding-bottom: 15px;
    }
    
    h1:after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: var(--primary-color);
    }
    
    .form-control {
      border-radius: var(--border-radius);
      padding: 12px 15px;
      border: 1px solid #ddd;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    label {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--secondary-color);
    }
    
    .btn-submit {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      padding: 12px 25px;
      border-radius: var(--border-radius);
      border: none;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 15px;
    }
    
    .btn-submit:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-submit:active {
      transform: translateY(0);
    }
    
    .result-container {
      margin-top: 30px;
      padding: 25px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid #eee;
      display: none;
    }
    
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 300px;
      border-radius: var(--border-radius);
      padding: 15px;
      border: 1px solid #ddd;
      font-family: 'Courier New', monospace;
      background-color: #f9f9f9;
    }
    
    #loader {
      display: none;
      text-align: center;
      margin: 25px 0;
    }
    
    .progress {
      height: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    .progress-bar {
      border-radius: 5px;
      background-color: var(--primary-color);
    }
    
    .btn-simple {
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 15px;
      font-weight: 500;
      padding: 12px 25px;
      text-align: center;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      width: 100%;
    }
    
    .btn-simple:hover {
      background-color: #219653;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-simple:active {
      transform: translateY(0);
    }
    
    #btnExecuter {
      margin-bottom: 15px;
    }
    
    .carousel {
      margin-top: 20px;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .carousel-item {
      padding: 20px;
      background: white;
      min-height: 400px;
    }
    
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      background-color: var(--primary-color);
      border-radius: 50%;
      padding: 15px;
      background-size: 50% 50%;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      border: none;
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      border: none;
    }
    
    .btn-success {
      background-color: var(--success-color);
      border: none;
    }
    
    .form-row {
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 24px;
      }
    }
    
    /* Animation pour les entr√©es */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-row > div {
      animation: fadeIn 0.5s ease-out forwards;
      animation-delay: calc(var(--order) * 0.1s);
      opacity: 0;
    }
    
    /* Style pour les tooltips */
    [data-toggle="tooltip"] {
      border-bottom: 1px dashed #999;
      cursor: help;
    }
    
        /* Dropdown simple */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  background: none;
  border: none;
  color: #374151;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  font-family: 'Roboto', sans-serif;
}

.dropdown-toggle:hover {
  color: #2563eb;
}

.dropdown-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 120%;
  background-color: white;
  width: 160px;
  border-radius: 0.5rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.dropdown:hover .dropdown-menu {
  display: block;
}

.dropdown-menu a {
  display: block;
  padding: 10px 16px;
  font-size: 0.875rem;
  color: #374151;
  text-decoration: none;
  transition: all 0.2s;
}

.dropdown-menu a:hover {
  background-color: #fef2f2;
  color: #dc2626;
}

.btn-submit {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            border: none;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-submit:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn {
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }
  .btn:hover {
    transform: translateY(-1px);
    background-color: #f8f9fa;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .custom-select-vertical {
    height: 38px; /* Bootstrap default */
    display: flex;
    align-items: center; /* centre verticalement le texte */
    padding-top: 0;
    padding-bottom: 0;
    text-align-last: left; /* align√© √† gauche */
  }














  </style>
</head>
<body>
 <!-- Barre de navigation avec menu utilisateur simplifi√© -->
<nav class="w-full bg-white shadow-md rounded-2xl mb-8 px-6 py-4">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <!-- Logo -->
    <div class="text-xl font-bold text-blue-600">NC-LoraSim</div>

    <!-- Menu principal -->
    <div class="flex items-center space-x-6">
      <a href="/index.html" class="text-gray-700 hover:text-blue-600 font-medium">Accueil</a>
      <a href="/connexion.html" class="text-gray-700 hover:text-blue-600 font-medium">Connexion</a>
      <a href="/simulation-manager.html" class="text-blue-600 font-semibold border-b-2 border-blue-600">
        Mode Automatique
      </a>
      <a href="/NS3-LoRaWan.html" class="text-gray-700 hover:text-blue-600 font-medium">Mode Manuel</a>
    </div>

  <!-- User menu -->
 <div class="dropdown">
  <button id="accountBtn" class="btn btn-light dropdown-toggle" type="button">
    Mon compte
  </button>
  <div id="accountMenu" class="dropdown-menu dropdown-menu-right">
    <a class="dropdown-item text-danger" href="/connexion.html">D√©connexion</a>
  </div>
</div>
</div>
</nav>

 


  <div class="container">
    <h1>NC-LoraSim : Mode Automatique</h1>
    <form id="form">
      <div class="form-row">
        <div class="col-md-4" style="--order: 1;">
          <label for="dValues">Liste des N≈ìuds</label>
          <input type="text" class="form-control" id="dValues" placeholder="10,20,30" required 
                 data-toggle="tooltip" data-placement="top" title="Nombre de n≈ìuds √† simuler (s√©par√©s par des virgules)" />
        </div>
        <div class="col-md-4" style="--order: 2;">
          <label for="gValues">Liste des Passerelles</label>
          <input type="text" class="form-control" id="gValues" placeholder="2,3" required 
                 data-toggle="tooltip" data-placement="top" title="Nombre de passerelles √† simuler (s√©par√©es par des virgules)" />
        </div>
        <div class="col-md-4" style="--order: 3;">
          <label for="Raduis">Rayon de simulation (m√®tres)</label>
          <input type="text" class="form-control" id="Raduis" placeholder="7500" required 
                 data-toggle="tooltip" data-placement="top" title="Rayon de la zone de simulation" />
        </div>
      </div>
    
      <div class="form-row mt-3">
        <div class="col-md-4" style="--order: 4;">
          <label for="tValue">Temps de Simulation (min)</label>
          <input type="number" class="form-control" id="tValue" placeholder="180" required 
                 data-toggle="tooltip" data-placement="top" title="Dur√©e totale de la simulation en minutes" />
        </div>
        <div class="col-md-4" style="--order: 5;">
          <label for="aValues">P√©riodes d'Application (min)</label>
          <input type="text" class="form-control" id="aValues" placeholder="3,6,9" required 
                 data-toggle="tooltip" data-placement="top" title="P√©riodes entre les envois de messages (s√©par√©es par des virgules)" />
        </div>
        <div class="col-md-4" style="--order: 6;">
          <label for="pValues">Tailles de Charge Utile (octets)</label>
          <input type="text" class="form-control" id="pValues" placeholder="10,20" required 
                 data-toggle="tooltip" data-placement="top" title="Tailles des paquets √† envoyer (s√©par√©es par des virgules)" />
        </div>
      </div>
    
      <div class="form-row mt-3">
        <div class="col-md-4" style="--order: 7;">
          <label for="rValue">Nombre de R√©p√©titions</label>
          <input type="number" class="form-control" id="rValue" placeholder="3" required 
                 data-toggle="tooltip" data-placement="top" title="Nombre de fois que chaque simulation sera r√©p√©t√©e" />
        </div>
        <div class="col-md-4" style="--order: 8;">
          <label for="DValue">D√©ploiement Al√©atoire</label>
          <select class="form-control custom-select-vertical" id="DValue">
            <option value="false">Non</option>
            <option value="true">Oui</option>
            <option value="true,false">Oui & Non</option>
          </select>
        </div>
        <div class="col-md-4" style="--order: 9;">
          <label for="TValue">Mod√®le de Trafic Poisson</label>
          <select class="form-control custom-select-vertical" id="TValue">
            <option value="false">Non</option>
            <option value="true">Oui</option>
            <option value="true,false">Oui & Non</option>
          </select>
        </div>
      </div>
    
      <div class="form-row mt-3">
        <div class="col-md-4" style="--order: 10;">
          <label for="Mecanisme">M√©canisme</label>
          <select class="form-control custom-select-vertical" id="Mecanisme">
            <option value="GeoNet">GeoNet</option>
            <option value="ADR">ADR</option>
          </select>
        </div>
        <div class="col-md-8"></div> <!-- espace vide pour √©quilibrer -->
      </div>
    
      <button type="submit" class="btn btn-submit btn-block mt-4" id="btnExecuter">
        <i class="fas fa-play-circle"></i> Ex√©cuter la Simulation
      </button>
    </form>
    
    
    <button class="btn btn-simple mt-3" id="btnAfficherCourbes" onclick="chargerDepuisHistorique()">
      <i class="fas fa-chart-line"></i> R√©cup√©ration des R√©sultats
    </button>
    
    <div id="loader">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-3">Simulation en cours... Veuillez patienter</p>
    </div>

    <div id="progressWrapper" class="mt-3" style="display: none;">
      <div class="d-flex justify-content-between mb-2">
        <label for="progressBar">Progression de la simulation :</label>
        <span id="progressText">0%</span>
      </div>
      <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    
    <div id="resultContainer" class="result-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-file-alt"></i> R√©sultats de la Simulation</h4>
        <div>
          <button class="btn btn-danger" onclick="stopSimulation()">
            <i class="fas fa-stop-circle"></i> Arr√™ter
          </button>
          <button class="btn btn-secondary ml-2" onclick="downloadResult()">
            <i class="fas fa-download"></i> T√©l√©charger
          </button>
        </div>
      </div>
      <textarea id="resultOutput" rows="15" class="form-control" readonly></textarea>
    </div>

    <div id="resultGraphContainer" class="result-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-chart-bar"></i> Performance Charts</h4>
        <button id="downloadZipBtn" class="btn btn-success">
          <i class="fas fa-file-archive"></i> Download Charts
        </button>
      </div>
      <div id="pdrChartContainer">
        <div id="carousel" class="carousel slide" data-ride="carousel">
          <ol class="carousel-indicators" id="carouselIndicators"></ol>
          <div class="carousel-inner" id="carouselItems"></div>
          <a class="carousel-control-prev" href="#carousel" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Pr√©c√©dent</span>
          </a>
          <a class="carousel-control-next" href="#carousel" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Suivant</span>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2 mt-3">
    <button class="btn btn-light border rounded-pill px-3 py-2 shadow-sm" onclick="afficherGraphiques(groupes)">
      üìà <strong>PDR </strong>
    </button>
    
    <button class="btn btn-light border rounded-pill px-3 py-2 shadow-sm" onclick="afficherGraphiquesMultiples(groupes, 'Payload')">
      üîÄ <strong>Payload</strong>
    </button>
    
    <button class="btn btn-light border rounded-pill px-3 py-2 shadow-sm" onclick="afficherGraphiquesMultiples(groupes, 'GW')">
      üõ∞Ô∏è <strong>Passerelles</strong>
    </button>
    
    <button class="btn btn-light border rounded-pill px-3 py-2 shadow-sm" onclick="afficherGraphiquesMultiples(groupes, 'P√©riode')">
      ‚è±Ô∏è <strong>P√©riode</strong>
    </button>
  </div>
  
  
  <script>



      const links = document.querySelectorAll('nav a');
  const currentUrl = window.location.pathname;
  links.forEach(link => {
    if (link.getAttribute('href') === currentUrl) {
      link.classList.add('text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-600');
    }
  });
     document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("accountBtn");
    const menu = document.getElementById("accountMenu");

    btn.addEventListener("click", function (e) {
      e.stopPropagation(); // Emp√™che la fermeture imm√©diate
      menu.classList.toggle("show");
    });

    document.addEventListener("click", function () {
      menu.classList.remove("show");
    });
  });
    // Ajout des ic√¥nes Font Awesome
    const fontAwesome = document.createElement('link');
    fontAwesome.rel = 'stylesheet';
    fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
    document.head.appendChild(fontAwesome);

    let eventSource = null;
    let groupes = {};

    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });

    document.getElementById("form").addEventListener("submit", function (event) {
      event.preventDefault();

      const dValues = document.getElementById("dValues").value;
      const gValues = document.getElementById("gValues").value;
      const tValue  = document.getElementById("tValue").value;
      const aValues = document.getElementById("aValues").value;
      const pValues = document.getElementById("pValues").value;
      const rValue  = document.getElementById("rValue").value;
      const DValue  = document.getElementById("DValue").value;
      const TValue  = document.getElementById("TValue").value;
      const Mecanisme  = document.getElementById("Mecanisme").value;

      localStorage.setItem('simulationParams', JSON.stringify({
        dValues, gValues, tValue, aValues, pValues, rValue, DValue, TValue
      }));

      const url = `/execute?dValues=${dValues}&gValues=${gValues}&tValue=${tValue}&aValues=${aValues}&pValues=${pValues}&rValue=${rValue}&DValue=${DValue}&TValue=${TValue}&Mecanisme=${Mecanisme}`;
      eventSource = new EventSource(url);

      document.getElementById("loader").style.display = "block";
      const resultOutput = document.getElementById("resultOutput");
      resultOutput.value = "";
      document.getElementById("resultContainer").style.display = 'block';
      document.getElementById("resultGraphContainer").style.display = 'none';

      eventSource.onmessage = function(event) {
        resultOutput.value += event.data + "\n";
        resultOutput.scrollTop = resultOutput.scrollHeight;

        document.getElementById("progressWrapper").style.display = "block";
        const match = event.data.match(/Progression\s*:\s*\d+\s*\/\s*\d+\s*\((\d+\.?\d*)%\)/);
        if (match) {
          const percent = parseFloat(match[1]);
          const progressBar = document.getElementById("progressBar");
          progressBar.style.width = `${percent}%`;
          progressBar.setAttribute("aria-valuenow", percent);
          document.getElementById("progressText").innerText = `${percent}%`;
        }

        if (event.data.includes("OK")) {
          eventSource.close();
          document.getElementById("loader").style.display = "none";
          resultOutput.value += "\n‚úÖ Simulation termin√©e avec succ√®s.\n";

          const progressBar = document.getElementById("progressBar");
          progressBar.style.width = "100%";
          progressBar.setAttribute("aria-valuenow", 100);
          document.getElementById("progressText").innerText = "100%";

          const simulationText = resultOutput.value;
          groupes = lireFichierTxt(simulationText);
          afficherGraphiques(groupes);
        }
      };

      eventSource.onerror = function(event) {
        console.error("Erreur SSE :", event);
        if (eventSource) eventSource.close();
        document.getElementById("loader").style.display = "none";
      };
    });

    function stopSimulation() {
      fetch('/stop')
        .then(res => res.text())
        .then(msg => {
          if (eventSource) eventSource.close();
          document.getElementById("resultOutput").value += "\n" + msg;
          document.getElementById("loader").style.display = "none";
          localStorage.removeItem('eventSourceState');
          localStorage.removeItem('simulationParams');
        });
    }

    function downloadResult() {
      const content = document.getElementById("resultOutput").value;
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `resultats_simulation_${new Date().toISOString().slice(0,10)}.txt`;
      link.click();
    }
    function lireFichierTxt(fichier) {
  const groupes = {};
  let contexte = "", appPeriod = "", payload = "", nGateway = "", deploiement = "", trafic = "";

  const lignes = fichier.split("\n");

  lignes.forEach(ligne => {
    ligne = ligne.trim();
    if (ligne.includes("deploiement_aleatoire") && ligne.includes("Trafic_poisson")) {
      const matchDep = ligne.match(/deploiement_aleatoire=(\w+)/);
      const matchTraf = ligne.match(/Trafic_poisson=(\w+)/);
      if (matchDep && matchTraf) {
        deploiement = matchDep[1];
        trafic = matchTraf[1];
        contexte = `D_aleatoire=${deploiement} | T_poisson=${trafic}`;
      }
    } else if (ligne.includes("p√©riode d'application de")) {
      const match = ligne.match(/p√©riode d'application de (\d+)/);
      if (match) appPeriod = match[1];
    } else if (ligne.includes("taille de charge utile de")) {
      const match = ligne.match(/charge utile de (\d+)/);
      if (match) payload = match[1];
    } else if (ligne.includes("Pour") && ligne.includes("Passerelles")) {
      const match = ligne.match(/Pour (\d+)/);
      if (match) nGateway = match[1];
    } else if (ligne.includes("|") && ligne.includes("Deploiement=")) {
      const parts = ligne.split("|").map(p => p.trim());
      if (parts.length >= 4) {
        try {
          const noeud = parseInt(parts[0]);
          const pdr = parseFloat(parts[3]) * 100;
          const nomCourbe = `${contexte} | P√©riode=${appPeriod} | Payload=${payload} | GW=${nGateway}`;
          if (!groupes[nomCourbe]) groupes[nomCourbe] = [];
          groupes[nomCourbe].push({ noeud, pdr });
        } catch (e) {
          console.error("Erreur de traitement des donn√©es :", e);
        }
      }
    }
  });
  return groupes;
}

    function clearCharts() {
      const carouselItems = document.getElementById("carouselItems");
      carouselItems.innerHTML = "";
      const carouselIndicators = document.getElementById("carouselIndicators");
      carouselIndicators.innerHTML = "";
    }

    function chargerDepuisHistorique() {
  document.getElementById("loader").style.display = "block";
  document.getElementById("progressWrapper").style.display = "block";
  
  fetch('/api/historique')
    .then(response => response.text())
    .then(texte => {
      const resultOutput = document.getElementById("resultOutput");
      resultOutput.value = texte;
      document.getElementById("resultContainer").style.display = 'block';
      document.getElementById("loader").style.display = "none";

      // ‚úÖ mise √† jour de la variable globale !
      groupes = lireFichierTxt(texte);

      afficherGraphiques(groupes);
      mettreAJourProgressionDepuisHistorique(texte);

      document.getElementById("downloadZipBtn").onclick = function() {
        downloadZip(groupes);
      };
    })
    .catch(err => {
      console.error("Erreur lors du chargement de l'historique :", err);
      alert("Impossible de charger le fichier historique.");
      document.getElementById("loader").style.display = "none";
    });
}


    function mettreAJourProgressionDepuisHistorique(fichierHistorique) {
      const lignes = fichierHistorique.split("\n");
      let progression = 0;
      let maxProgression = 0;

      // Trouver la progression maximale dans le fichier
      lignes.forEach(ligne => {
        const match = ligne.match(/Progression\s*:\s*(\d+)\s*\/\s*(\d+)\s*\((\d+\.?\d*)%\)/);
        if (match) {
          const current = parseInt(match[1]);
          const total = parseInt(match[2]);
          const percent = parseFloat(match[3]);
          
          if (percent > progression) {
            progression = percent;
          }
          if (total > maxProgression) {
            maxProgression = total;
          }
        }
      });

      // Mettre √† jour la barre de progression
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      
      if (maxProgression > 0) {
        progressBar.style.width = `${progression}%`;
        progressBar.setAttribute("aria-valuenow", progression);
        progressText.innerText = `${progression}% (${Math.round(progression * maxProgression / 100)}/${maxProgression})`;
      } else {
        progressBar.style.width = "100%";
        progressBar.setAttribute("aria-valuenow", 100);
        progressText.innerText = "100% (donn√©es historiques)";
      }
    }
    function afficherGraphiques(groupes) {
  document.getElementById("loader").style.display = "none";
  document.getElementById("resultGraphContainer").style.display = "block";
  clearCharts();

  const carouselIndicators = document.getElementById("carouselIndicators");
  
  Object.keys(groupes).forEach((nomCourbe, index) => {
    const valeurs = groupes[nomCourbe].sort((a, b) => a.noeud - b.noeud);
    const x = valeurs.map(v => v.noeud);
    const y = valeurs.map(v => v.pdr);

    // Cr√©e l‚Äôindicateur de carousel
    const indicator = document.createElement("li");
    indicator.dataset.target = "#carousel";
    indicator.dataset.slideTo = index;
    if (index === 0) indicator.classList.add("active");
    carouselIndicators.appendChild(indicator);

    // Cr√©e l‚Äôitem du carousel
    const carouselItem = document.createElement("div");
    carouselItem.classList.add("carousel-item");
    if (index === 0) carouselItem.classList.add("active");

    const canvas = document.createElement("canvas");
    canvas.id = `chart${index}`;
    carouselItem.appendChild(canvas);
    document.getElementById("carouselItems").appendChild(carouselItem);

    new Chart(canvas, {
      type: 'line',
      data: {
        labels: x,
        datasets: [{
          label: nomCourbe,
          data: y,
          borderColor: getRandomColor(),
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointBackgroundColor: '#fff',
          pointBorderColor: getRandomColor(),
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: nomCourbe,
            font: {
              size: 16,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Noeud ${context.label}: ${context.raw.toFixed(2)}%`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Nombre de Noeuds',
              font: { weight: 'bold' }
            },
            grid: { display: false }
          },
          y: {
            title: {
              display: true,
              text: 'Packet Delivery Ratio (%)',
              font: { weight: 'bold' }
            },
            min: 0,
            max: 100,
            ticks: {
              callback: value => value + '%'
            }
          }
        }
      }
    });
  });

  $('#carousel').carousel();
}


    function getRandomColor() {
      const colors = [
        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#d35400', '#34495e', '#16a085', '#c0392b'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedParams = JSON.parse(localStorage.getItem('simulationParams'));
      if (savedParams) {
        document.getElementById("dValues").value = savedParams.dValues || '';
        document.getElementById("gValues").value = savedParams.gValues || '';
        document.getElementById("tValue").value  = savedParams.tValue || '';
        document.getElementById("aValues").value = savedParams.aValues || '';
        document.getElementById("pValues").value = savedParams.pValues || '';
        document.getElementById("rValue").value  = savedParams.rValue || '';
        document.getElementById("DValue").value  = savedParams.DValue || 'false';
        document.getElementById("TValue").value  = savedParams.TValue || 'false';
      }
    });

    function downloadZip(groupes) {
      const zip = new JSZip();
      const chartFiles = [];

      // Cr√©er un fichier .png pour chaque graphique g√©n√©r√©
      Object.keys(groupes).forEach((nomCourbe, index) => {
        const canvas = document.getElementById(`chart${index}`);
        if (canvas) {
          // Convertir chaque graphique en image PNG
          const imgData = canvas.toDataURL("image/png");

          // Convertir l'image en binaire
          const byteString = atob(imgData.split(',')[1]);
          const byteArray = new Uint8Array(byteString.length);
          for (let i = 0; i < byteString.length; i++) {
            byteArray[i] = byteString.charCodeAt(i);
          }

          // Ajouter l'image au fichier .zip
          zip.file(`${nomCourbe.replace(/[\/\\?%*:|"<>]/g, '_')}.png`, byteArray);
        }
      });

      // G√©n√©rer et t√©l√©charger le fichier .zip
      zip.generateAsync({ type: "blob" })
        .then(function(content) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(content);
          link.download = `courbes_simulation_${new Date().toISOString().slice(0,10)}.zip`;
          link.click();
        });
    }






    function regrouperCourbes(groupes, critere = "Payload") {
  const multiCourbes = {};

  Object.keys(groupes).forEach(nom => {
    // Nouveau regex qui capture aussi Deploiement et Trafic
    const regex = /D_aleatoire=(\w+)\s+\|\s+T_poisson=(\w+).*?P√©riode=(\d+)\s+\|\s+Payload=(\d+)\s+\|\s+GW=(\d+)/;
    const match = nom.match(regex);
    
    if (match) {
      const [_, deploiement, trafic, periode, payload, gw] = match;
      let cle = `D=${deploiement} | T=${trafic} | `;
      
      if (critere === "Payload") cle += `P=${periode} | GW=${gw}`;
      else if (critere === "GW") cle += `P=${periode} | Payload=${payload}`;
      else if (critere === "P√©riode") cle += `Payload=${payload} | GW=${gw}`;

      if (!multiCourbes[cle]) multiCourbes[cle] = [];
      multiCourbes[cle].push({ 
        label: nom, 
        data: groupes[nom],
        deploiement,
        trafic
      });
    }
  });

  return multiCourbes;
}
function afficherGraphiquesMultiples(sourceGroupes, critere = "Payload") {
  if (!sourceGroupes || Object.keys(sourceGroupes).length === 0) {
    if (typeof groupes !== 'undefined' && groupes && Object.keys(groupes).length > 0) {
      sourceGroupes = groupes;
    } else {
      alert("Aucune donn√©e de simulation disponible.");
      return;
    }
  }

  const regroupements = regrouperCourbes(sourceGroupes, critere);
  clearCharts();
  const carouselIndicators = document.getElementById("carouselIndicators");

  Object.keys(regroupements).forEach((cle, index) => {
    const series = regroupements[cle];

    const datasets = series.map((serie, i) => {
      let legende = "";
      const regex = /D_aleatoire=(\w+)\s+\|\s+T_poisson=(\w+).*?P√©riode=(\d+)\s+\|\s+Payload=(\d+)\s+\|\s+GW=(\d+)/;
      const match = serie.label.match(regex);
      
      if (match) {
        const [_, deploiement, trafic, periode, payload, gw] = match;
        
        // Nouveau format de l√©gende qui inclut les param√®tres pertinents
        if (critere === 'Payload') legende = `Payload=${payload} (D=${deploiement}, T=${trafic})`;
        else if (critere === 'GW') legende = `GW=${gw} (D=${deploiement}, T=${trafic})`;
        else if (critere === 'P√©riode') legende = `P√©riode=${periode} (D=${deploiement}, T=${trafic})`;
      } else {
        legende = serie.label.replace(/\s*\|\s*/g, " |");
      }

      // Couleur bas√©e sur le crit√®re principal + param√®tres
      const hue = (i * 360 / series.length) % 360;
      const saturation = serie.deploiement === 'true' ? '70%' : '40%';
      const lightness = serie.trafic === 'true' ? '50%' : '60%';
      const couleur = `hsl(${hue}, ${saturation}, ${lightness})`;

      return {
        label: legende,
        data: serie.data.sort((a, b) => a.noeud - b.noeud).map(p => p.pdr),
        borderColor: couleur,
        backgroundColor: couleur,
        fill: false,
        tension: 0.3,
        pointRadius: 3,
        borderDash: serie.deploiement === 'true' ? [] : [5, 5], // Style diff√©rent pour d√©ploiement al√©atoire
        borderWidth: serie.trafic === 'true' ? 2 : 1 // √âpaisseur diff√©rente pour trafic poisson
      };
    });

    // Reste du code inchang√©...
    const labels = series[0].data.sort((a, b) => a.noeud - b.noeud).map(p => p.noeud);

    const indicator = document.createElement("li");
    indicator.dataset.target = "#carousel";
    indicator.dataset.slideTo = index;
    if (index === 0) indicator.classList.add("active");
    carouselIndicators.appendChild(indicator);

    const carouselItem = document.createElement("div");
    carouselItem.classList.add("carousel-item");
    if (index === 0) carouselItem.classList.add("active");

    const canvas = document.createElement("canvas");
    canvas.id = `multiChart${index}`;
    carouselItem.appendChild(canvas);
    document.getElementById("carouselItems").appendChild(carouselItem);

    new Chart(canvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: `Comparaison par ${critere} : ${cle}`,
            font: { size: 16, weight: 'bold' }
          },
          legend: {
            display: true,
            position: 'right',
            labels: {
              boxWidth: 12,
              padding: 15,
              usePointStyle: true,
              font: {
                size: 12,
                family: 'Roboto',
                weight: 'normal'
              }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => {
                const label = ctx.dataset.label || '';
                const value = ctx.raw.toFixed(2) + '%';
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          x: { 
            title: { 
              display: true, 
              text: 'Nombre de Noeuds',
              font: { weight: 'bold' }
            } 
          },
          y: {
            title: { 
              display: true, 
              text: 'PDR (%)',
              font: { weight: 'bold' }
            },
            min: 0, 
            max: 100,
            ticks: { 
              callback: val => val + '%',
              stepSize: 10
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  });
}























  </script>





























  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>